{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "adminUsername": {
      "type": "string"
    },
    "adminPassword": {
      "type": "securestring"
    },
    "sqlVMName": {
      "type": "string"
    },
    "location": {
      "type": "string"
    },
    "noOfSqlVm": {
      "type": "int"
    },
    "domainName": {
      "type": "string"
    },
    "numberOfDisks":{  
      "type":"string"
    },
    "workloadType":{  
      "type":"string"
    },
    "sqlAOPrepareModulesURL":{  
        "type":"string"
    },
    "sqlAOPrepareConfigurationFunction":{  
        "type":"string"
    },
    "sqlAOEPName":{  
        "type":"string"
    },
    "sqlServerServiceAccountUserName":{  
        "type":"string"
    },
    "sqlServerServiceAccountPassword":{  
        "type":"securestring"
    }
  },
  "resources": [
    {   
        "type":"Microsoft.Compute/virtualMachines/extensions",
        "name":"[concat(parameters('sqlVMName'),copyindex(),'/sqlAOPrepare')]",
        "apiVersion":"2015-06-15",
        "location":"[parameters('location')]",
        "copy": {
          "name": "sqlVmIaasSqlAOPrepareLoop",
          "count": "[parameters('noOfSqlVm')]"
        },
        "dependsOn": [
          "[concat('Microsoft.Compute/virtualMachines/',parameters('sqlVMName'),copyindex())]" 
        ],
        "properties":{  
            "publisher":"Microsoft.Powershell",
            "type":"DSC",
            "typeHandlerVersion":"2.19",
            "autoUpgradeMinorVersion":false,
            "settings":{  
              "modulesURL":"[parameters('sqlAOPrepareModulesURL')]",
              "configurationFunction":"[parameters('sqlAOPrepareConfigurationFunction')]",
              "properties":{  
                  "domainName":"[parameters('domainName')]",
                  "sqlAlwaysOnEndpointName":"[parameters('sqlAOEPName')]",
                  "adminCreds":{  
                    "userName":"[parameters('adminUserName')]",
                    "password":"privateSettingsRef:AdminPassword"
                  },
                  "sqlServiceCreds":{  
                    "userName":"[parameters('sqlServerServiceAccountUserName')]",
                    "password":"privateSettingsRef:SqlServerServiceAccountPassword"
                  },
                  "NumberOfDisks":"[parameters('numberOfDisks')]",
                  "WorkloadType":"[parameters('workloadType')]"
              }
            },
            "protectedSettings":{  
              "items":{  
                  "adminPassword":"[parameters('adminPassword')]",
                  "sqlServerServiceAccountPassword":"[parameters('sqlServerServiceAccountPassword')]"
              }
            }
        }
    }
  ],
  "outputs": {}
}
